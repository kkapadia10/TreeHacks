"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.formatString = exports.intlNormalizedLocale = exports.getString = exports.formatId = exports.setTranslationBundlesContainer = exports.encodeAsInvisibleUnicode = exports.getLocale = void 0;
const bootstrap_1 = require('../../../base/bootstrap/bootstrap');
const intl_messageformat_1 = require("intl-messageformat");
const key_1 = require('../bootstrap/key');
const ui_bootstrap_proto_1 = require('../bootstrap/ui_bootstrap_proto');
const window_ = typeof window === 'undefined' ? undefined : window;
let strings_ = ((_a = window_ === null || window_ === void 0 ? void 0 : window_['cmsg']) === null || _a === void 0 ? void 0 : _a['strings']) || {};
const cache_ = new Map();
let locale_;
const getLocale = () => { var _a; return (locale_ = locale_ || ((_a = window_ === null || window_ === void 0 ? void 0 : window_['cmsg']) === null || _a === void 0 ? void 0 : _a['locale']) || 'en'); };
exports.getLocale = getLocale;
let exposeStringIds = false;
if (window_ != null) {
    const bootstrap = (0, bootstrap_1.loadFromWindow)(key_1.uiBootstrapKey, ui_bootstrap_proto_1.UiBootstrap.deserialize, {
        applyOverrides: true,
    });
    exposeStringIds = bootstrap.exposeStringIds;
}
function encodeAsInvisibleUnicode(id) {
    return id
        .replace(/./g, s => s.charCodeAt(0).toString(2).padStart(8, '0'))
        .replace(/0/g, '\u2062')
        .replace(/1/g, '\u2064');
}
exports.encodeAsInvisibleUnicode = encodeAsInvisibleUnicode;
function addInvisibleStringId(string, id) {
    return '\u2062' + string + encodeAsInvisibleUnicode(id);
}
function setTranslationBundlesContainer(cmsgContainer, locale) {
    var _a;
    cache_.clear();
    locale_ = locale;
    strings_ = ((_a = cmsgContainer === null || cmsgContainer === void 0 ? void 0 : cmsgContainer['cmsg']) === null || _a === void 0 ? void 0 : _a['strings']) || {};
}
exports.setTranslationBundlesContainer = setTranslationBundlesContainer;
function formatId(
    id,
    args,
    fallbackString,
    locale = (0, exports.getLocale)(),
    strings = strings_,
    cache = cache_,
    createIntlMessageFormat = createIntlMessageFormat_
) {
    const argumentzRecord = {};
    for (let i = 0; i < args.length; ++i) {
        argumentzRecord[i] = args[i];
    }
    const cached = cache.get(id);
    if (cached) {
        const result = cached.format(argumentzRecord);
        return exposeStringIds ? addInvisibleStringId(result, id) : result;
    }
    const localeStrings = strings[locale];
    let string = localeStrings && localeStrings[id];
    if (string == null) {
        string = fallbackString;
    }
    if (string == null) {
        throw new Error(`Could not find string for ${locale} ${id}`);
    }
    const format = createIntlMessageFormat(string, locale);
    cache.set(id, format);
    const result = format.format(argumentzRecord);
    return exposeStringIds ? addInvisibleStringId(result, id) : result;
}
exports.formatId = formatId;
function getString(id, fallbackString, locale = (0, exports.getLocale)(), strings = strings_) {
    const localeStrings = strings[locale];
    let string = localeStrings && localeStrings[id];
    if (string == null) {
        string = fallbackString;
    }
    if (string == null) {
        throw new Error(`Could not find string for ${locale} ${id}`);
    }
    return exposeStringIds ? addInvisibleStringId(string, id) : string;
}
exports.getString = getString;
const formats = {
    date: {
        ['weekday']: { weekday: 'long' },
        ['mediumNoYear']: { month: 'short', day: 'numeric' },
        ['mediumNoYearUTC']: { month: 'short', day: 'numeric', timeZone: 'UTC' },
        ['monthUTC']: { month: 'long', timeZone: 'UTC' },
        ['shortMonthUTC']: { month: 'short', timeZone: 'UTC' },
        ['monthYear']: { month: 'long', year: 'numeric' },
        ['monthYearUTC']: { month: 'long', year: 'numeric', timeZone: 'UTC' },
        ['longNoYear']: { month: 'long', day: 'numeric' },
        ['longUTC']: { month: 'long', day: 'numeric', year: 'numeric', timeZone: 'UTC' },
    },
};
const intlNormalizedLocale = (locale) => {
    let _locale = locale;
    switch (locale) {
        case 'en-psaccent':
            _locale = 'en';
            break;
        case 'ar':
        case 'ar-AE':
        case 'ar-EG':
        case 'ar-SA':
        case 'fa-IR':
        case 'he-IL':
        case 'pa-PK':
        case 'ur-PK':
        case 'ckb-IQ':
        case 'ug-CN':
            _locale = `${locale}-u-nu-latn`;
            break;
        default:
            _locale = locale;
            break;
    }
    try {
        intl_messageformat_1.default.resolveLocale(_locale);
    }
    catch (err) {
        _locale = intl_messageformat_1.default.defaultLocale;
    }
    return _locale;
};
exports.intlNormalizedLocale = intlNormalizedLocale;
function createIntlMessageFormat_(ztring, locale) {
    return new intl_messageformat_1.default(ztring, (0, exports.intlNormalizedLocale)(locale), formats, { ignoreTag: true });
}
function formatString(ztring, values, locale) {
    return new intl_messageformat_1.default(ztring, locale ? (0, exports.intlNormalizedLocale)(locale) : undefined, formats, {
        ignoreTag: true,
    }).format(Object.fromEntries(Object.entries(values)));
}
exports.formatString = formatString;
