"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.memoize = void 0;
const preconditions_1 = require("./preconditions");
const result_1 = require("./result");
function isPromiseLike(p) {
    return p != null && p.then != null;
}
function memoize(fn, opts = { invalidateOnError: false }) {
    let promiseDidReject = false;
    let result;
    const memoFn = (...args) => {
        preconditions_1.Preconditions.checkArgument(args.length === 0);
        if (result == null || (opts.invalidateOnError && (!result.ok || promiseDidReject))) {
            try {
                promiseDidReject = false;
                result = result_1.Result.Ok(fn());
                if (isPromiseLike(result.value)) {
                    result.value.then(null, _e => (promiseDidReject = true));
                }
            }
            catch (e) {
                result = result_1.Result.Err(e);
            }
        }
        if (result.ok) {
            return result.value;
        }
        else {
            throw result.error;
        }
    };
    return memoFn;
}
exports.memoize = memoize;
